<!--
   - For https://chrome.google.com/webstore/detail/mgmiemnjjchgkmgbeljfocdjjnpjnmcg
   -->
<script src="js/jquery.js" type="text/javascript"></script>
<script src="js/calendar.js" type="text/javascript"></script>
<script src="js/helpers.js" type="text/javascript"></script>

<script type="text/javascript">
	// Learn more about poke v2 here:
	// https://github.com/michaelhart/Awesome-New-Tab-Page/wiki/Poke-v2
	var info = {
	  "poke"    :   2,              // poke version 2
	  "width"   :   1,              // 406 px default
	  "height"  :   2,              // 200 px default
	  "path"    :   "widget.html",
	  "v2"      :   {
	                  "resize"    :   true,  // Set to true ONLY if you create a range below.
	                  "min_width" :   1,
	                  "max_width" :   2,
	                  "min_height":   2,
	                  "max_height":   2
	                }
	};
	
	chrome.extension.onRequestExternal.addListener(function(request, sender, sendResponse) {
	  if(request === "mgmiemnjjchgkmgbeljfocdjjnpjnmcg-poke") {
	    chrome.extension.sendRequest(
	      sender.id,
	      {
	        head: "mgmiemnjjchgkmgbeljfocdjjnpjnmcg-pokeback",
	        body: info
	      }
	    );
	  }
	});

    $(document).ready(function() {
	    		
        var w = Blz.Widget,
            gcal = Blz.Google.Calendar,
            app = MyGoogleCal.Application;

        window.localStorage.removeItem('events');
        window.localStorage['bg_reloading'] = false;
        gcal.source = 'shayko-GoogleEventsANTP-1';
        gcal.useGoogleLogin = (w.getPref('useGoogleApps')=='1');
        app.initialize();

        $(window).bind('storage', function(){
            //bg_update is if we should force a bg refresh
            var bg_update = !!(localStorage.getItem("bg_update") == "true");
            if(bg_update){
                update(true);
                localStorage.removeItem("bg_update");
            }
        });

        //When the user updates the tab url, for logging in
        chrome.tabs.onUpdated.addListener(onTabUpdated);
        function onTabUpdated(tabId, changeInfo) {
            var url = changeInfo.url;
            if (!url) return;
            if ((url.indexOf('//www.google.com/calendar/') != -1) ||
                    ((url.indexOf('//www.google.com/a/') != -1) && (url.lastIndexOf('/acs') == url.length - 4)) ||
                    (url.indexOf('//www.google.com/accounts/') != -1))
            {
                // The login screen isn't helpful
                if (url.indexOf('https://www.google.com/accounts/ServiceLogin?') == 0) {
                    return;
                }
                w.print("background.onTabUpdated: loginStatusChanged");
                update(true);
            }
        }

        function update(force) {

            log("[NOTICE] Updating Background Page");
            localStorage["bg_reloading"] = "true";

            //Refreshes the cached events
            if (force) {
                log("[NOTICE] Forced Update!");
                app.retrieveAllCalendar();return;
            }

            // Check if the application is logging in
            if (app.isLoginRequesting()) {
                log("[WARNING] Request Login!");
                widget_notify('loading', getResourceString('LOADING_EVENT'));
                //widget_notify('login_requesting', getResourceString('NOW_LOGIN'));
                return;
            }

            // Check if the client is logged in
            if (!app.isLogin()) {
                log("[WARNING] Not Logged In!");
                widget_alert('widget_require_login', getResourceString('SESSION_ERROR_ALERT', ["https://www.google.com/calendar/"]));
                return;
            }else widget_alert('widget_require_login', false);

            // Check if were currently waiting for calendars
            if (app.isCalendarListRequesting()) {
                log("[WARNING] Calendar is already requesting.");
                widget_notify('loading', getResourceString('LOADING_EVENT'));
                //widget_notify('calendars_requesting', "Updating Calendars...");
                return;
            }

            // Check if we have any calendars
            if (app.gcal.cacheCalendars.length == 0){
                log("[WARNING] No cached calendars");
                widget_notify('no_calendars', getResourceString('NOTHING_DISPLAY_EVENT'));
                return;
            }else widget_notify('no_calendars', false);

            //Retrieve the events for all calendars
			var cStart = new Blz.GData.Date().resetHours();
			var events = [], cache = app.getAppointments(cStart); // copy the array to add repeaters
            for (calid in cache.items) {
				var cal = app.findCalendarById(calid);
				if (cal && cal.selected)events = events.concat(cache.items[calid]);
			}
			
            localStorage["events"] = JSON.stringify(events);
            localStorage["bg_reloading"] = false;
            widget_notify('loading', false);
        }

        // Local callbacks that plugin to the Google Calendar module.
        var observer = {
            onMyGoogleCalLoginCompleted: function(a, b){},
            onMyGoogleCalCalendarLoaded: function(a, b){},
            onMyGoogleCalEventLoaded: function(a, b){}
        };

        Blz.Util.extend(observer, {
            onMyGoogleCalLoginCompleted: function(sender, event) {
                log("[EVENT] Cal Login Complete", event);
                if (event.success)app.retrieveAllCalendar();
                update();
            },
            onMyGoogleCalCalendarLoaded: function(sender, event) {
                log("[EVENT] Calendar Loaded", event);
                update();
            },
            onMyGoogleCalEventLoaded: function(sender, event) {
                log("[EVENT] Event Loaded", event);
                update();
            }
        });

        var alerts = {};
        //Sends an alert to the widget, which prevents the calendar from actioning
        function widget_alert(key, msg){
            alerts = JSON.parse(localStorage.getItem('widget_alert'));
            //Check if were deleting the alert
            if(msg == "" || msg === false){
                delete alerts[key];
            }else{
                log("[WIDGET_ALERT]", msg);
                alerts[key] = msg;
            }
            localStorage["widget_alert"] = JSON.stringify(alerts);
        }

        var notifications = {};
        notifications.base = [];
        function widget_notify(key, msg){
            notifications = JSON.parse(localStorage.getItem('widget_notify'));
            if (typeof (notifications.base) == "undefined") notifications.base = [];
            //Check if were deleting the notification
            if(arguments.length == 1){ msg = key; key = false; }
            if(msg === false){ msg = ""; }

            log("[WIDGET_NOTIFY] [" + key + "] = '" + msg + "'");
            if(key === false){
                if(jQuery.inArray(msg, notifications.base) < 0 )notifications.base.push(msg);
            }else notifications[key] = msg;
            localStorage["widget_notify"] = JSON.stringify(notifications);
        }

        function widget_update(){
            log("[WIDGET_UPDATE] Sent");
            localStorage['widget_update'] = true;
        }

        //Clear the notifications and alerts
        localStorage.removeItem("widget_notify");
        localStorage.removeItem("widget_alert");
        localStorage["widget_notify"] = JSON.stringify(notifications);
        localStorage["widget_alert"] = JSON.stringify(alerts);

        console.log("Local Storage On Load:");
        console.log(localStorage);

        app.addObserver(observer);

        //How often to update the bg refresh
        setInterval(function(){update();},w.getPref('update_interval')*60*1000);
        // update for modified events via 5 min
        setInterval(function(){update(true);},w.getPref('update_interval_force')*60*1000);
        update(true);

        window.update = update; //Store Update as a global variable for external script access
    });
</script>
